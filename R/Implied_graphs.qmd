---
title: "Implied graphs from individual stdies "
subtitle: "Indoor dust microbiome (exposure) and allergic diseases (outcome)"
author: 
  - "Javier Mancilla Galindo, MSc student"
  - "Supervisors: Inge Wouters and Alex Bossers"
  - "Examiner: Lidwien Smit"
date: today
execute: 
  echo: false
  warning: false
toc: true
format:
  pdf:
    documentclass: scrartcl
  docx:
    highlight-style: github
bibliography: ../docs/manuscript/references-dust-microbiome-review.bib
csl: ../docs/manuscript/environment-international.csl
editor: source
---

\pagebreak

# Packages and session information

```{r}
#| echo: true 
if (!require("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

pacman::p_load(
  tidyverse,   # Used for basic data handling and visualization.
  dagitty,     # Used to produce implied graphs and hypothetical DAG, and to 
               # analyze properties of such graphs. 
  DiagrammeR,  # Used to plot example DAG of study Num 1
  gt,          # Print and save html tables.
  report       # Used to generate package citations in markdown format.
)

```

```{r}
psfolder <- "../data/processed"
figfolder <- "../results/output_figures/implied_graphs"
dir.create(psfolder, showWarnings = FALSE)
dir.create(figfolder, showWarnings = FALSE)

# Credits chunk of code: Alex Bossers, Utrecht University

session <- sessionInfo()
# remove clutter
session$BLAS <- NULL
session$LAPACK <- NULL
session$loadedOnly <- NULL

# write log file
writeLines(
  capture.output(print(session, locale = FALSE)),
  paste0("sessions/",lubridate::today(), "_session_implied_graphs.txt")
)

session
```

\pagebreak

# Load data   

```{r}
# Load data 
load(paste0(psfolder,"/Data_Dust_Microbiome_Review.RData"))

data <- Data_Dust_Microbiome_Review@data

str(Data_Dust_Microbiome_Review, max.level = 2)
```

# Selection of studies

I will create a subset of studies named `subset_studies` that includes only those studies for which the ***microbiome*** is the exposure and ***allergy*** is the outcome.

```{r}
subset_studies <- data %>% 
  separate_rows(Determinant, sep = ", ") %>% 
  separate_rows(Outcome, sep = ", ") %>% 
  filter(Determinant == "microbiome" & Outcome == "allergies") 
```

Out of the `r count(data)` entries in `data`, there are **`r count(subset_studies)` studies** meeting the inclusion criteria for mapping into a directed acyclic graph according to the procedure described by [@Ferguson2020].

> Note: Studies where the reverse association (`allergy -> microbiome`) was studied could have also been included in the mapping procedure. However, none of the studies included reported having studied such directionality of association.

# Mapping individual studies into implied graphs

The figures for every graph produced by the subsequent code sourced for every study can be found in the [results folder](https://github.com/javimangal/Dust-Microbiome-Review/tree/main/results/output_figures/implied_graphs).

> Note that the saved figures will have different variable layouts every time they are generated. I have decided not to attach coordinates to variables to simplify the implied graphs' code since the interest at this stage is on the content of the graph rather than visualization.   

\pagebreak

### Num 1 [@fu2023a]

-   Exposure: microbial richness/concentration

-   Outcome: allergic rhinitis / non-allergic rhinitis symptoms

-   Control variables: **gender**, current **smoking**, and **parental asthma**

-   Other: Effect of **relative humidity** and **dust weight** on rhinitis symptoms is concluded to be *mediated* through the microbiome. 

The implied graph would have the following appearance: 
```{r}
grViz("digraph {
  graph []
  node [shape = plaintext]
    A [label = 'dust weight']
    B [label = 'humidity']
    E [label = 'dust microbiome']
    O [label = 'allergy']
    C1 [label = 'parental asthma']
    C2 [label = 'gender']
    C3 [label = 'smoking']
  edge []
    E->O
    A->E
    B->E
    C1->E
    C1->O
    C2->E
    C2->O
    C3->E
    C3->O
  { rank = same; A; B }
  { rank = same; E }
  { rank = same; C1; C2; C3 }
  { rank = same; O }
}
")
```


This is an example of the tables that will be produced for each implied graph to be used in the synthesis phase to produce a DAG.   
```{r}
source("implied_graphs/1_fu2023a.R")

edges_1_fu2023 %>% gt %>% 
  cols_hide(
    columns = c(v,w,e)
  ) %>% 
  cols_width(
    Num ~ pct(7),
    Edge ~ pct(33),
    Explanation ~ pct(60)
  ) %>%
  tab_options(
    table.width = pct(100)
  )
```

\pagebreak

### Num 9 [@fu2022a]

-   Exposure: microbial richness/ taxa absolute quantity 

-   Outcome: asthma

-   Control variables: **gender**, current **smoking**, and **parental asthma**

-   Other: Effect of **relative humidity**, **indoor CO2**, and **dust weight** on asthma are potentially *mediated* through the microbiome.

```{r}
#| echo: true
source("implied_graphs/9_fu2022a.R")
```


### Num 14 [@cox2022a]

The edges in this graph have been extracted as is from Figure 1 in the paper.

```{r}
#| echo: true 
source("implied_graphs/14_cox2022a.R")
```

By definition, directed acyclic graphs should not contain cycles. Since this DAG is more complex, I will test if it is indeed acyclic. 

```{r}
#| echo: true
isAcyclic(ig_14_cox2022a)
```

### Num 15 [@du2022a]

-   Exposure: airborne fungal concentration 

-   Outcome: asthma / wheeze / allergic rhinitis / eczema  

-   Control variables: gender, age, urbanicity, and genetic disorders in family 

-   Other: Concluded that allergy is related to season and humidity, whereas indoor fungal microbiome is correlated with season, humidity, temperature, indoor CO2, and the outdoor microbiome. 

```{r}
#| echo: true
source("implied_graphs/15_du2022a.R")
```

\pagebreak
### Num 19 [@fu2021a]

-   Exposure: bacterial richness / bacterial genera 

-   Outcome: asthma (self-administered questionnaire, supervised by healthcare professionals)

-   Control variables: **gender**, current **smoking**, and **parental asthma**

-   Other: plants in room, location in building, age of building, and wall surface type were associated with indoor microbiome. These characteristics were not associated with asthma. 

```{r}
#| echo: true
source("implied_graphs/19_fu2021a.R")
```

### Num 25 [@ta2021a]

-   Exposure: bacterial relative abundance 

-   Outcome: early life eczema

-   Control variables: None

-   Other: None of the conclusions support other variables to include in graph. 

```{r}
#| echo: true
source("implied_graphs/25_ta2021a.R")
```

### Num 27 [@hyytiaeinen2021a]

-   Exposure: Bacterial richness 

-   Outcome: Inhalant atopy (sensitization against at least one of the 13 or 8 tested specific inhalant allergens) / allergic rhinitis at 10-1.5 years.  

-   Control variables: gender, parental atopy (either mother or father reporting asthma, eczema or hay fever, if at least one of the parents were answered the question) and number of older siblings in both cohorts, maternal education, living on a farm and cohort in LUKAS; and parental education (the highest level of either parent) and study center in LISA. season of dust sampling in both cohorts; the number of different pet species indoors in LUKAS; and age of the mother during delivery in LISA. 

-   Other: None

```{r}
#| echo: true
source("implied_graphs/27_hyytiaeinen2021a.R")
```

\pagebreak
### Num 32 [@vandenborght2021a]

-   Exposure: diversity, abundance 

-   Outcome: severe asthma endotype (T2-high vs T2-low) / asthma exacerbation. 

-   Control variables: None declared. 

-   Other: None declared. 

```{r}
#| echo: true
source("implied_graphs/32_vandenborght2021a.R")
```

### Num 33 [@adams2021a]

-   Exposure: bacterial/fungal diversity, richness, individual taxa. Additionally, moisture damage of schools was an exposure of interest. 

-   Outcome: respiratory symptoms: wheeze, nocturnal dry cough, and rhinitis, on questionnaire administered 2 months **before** exposure assessment. 

-   Control variables: gender, age, moisture damage in home (note that this is different to moisture damage in school, where samples were taken), educational level 

-   Other: endotoxin and microbial taxa mediate 30% of the effect of moisture damage in school on respiratory symptoms. 

```{r}
#| echo: true
source("implied_graphs/33_adams2021a.R")
```

### Num 35 [@fu2021e]

-   Exposure: microbial richness/abundance

-   Outcome: asthma / wheezing, / rhinitis / rhinoconjunctivitis 

-   Control variables: smoking, gender, parental_allergies

-   Other: urbanicity related to dust microbiome and allergy. Effect of dust microbiome could occur through metabolism-related genes and immune-related mechanisms. 

```{r}
#| echo: true
source("implied_graphs/35_fu2021e.R")
```

\pagebreak
### Num 37 [@fu2020a]

-   Exposure: richness / taxa 

-   Outcome: history of asthma / asthma 

-   Control variables: smoking, gender, parental_allergies

-   Other:  indoor dampness/ visible mold (I will record this as humidity), which did not associate with microbial community variation, was associated with the asthma-associated bacteria. Other environmental characteristics in this study were not significantly associated. 

```{r}
#| echo: true
source("implied_graphs/37_fu2020a.R")
```

### Num 38 [@j2020a]

-   Exposure: bacterial and fungal taxa 

-   Outcome: household with inhabitants with an asthma diagnosis

-   Control variables: Not reported 

-   Other: No additional statements 

```{r}
#| echo: true
source("implied_graphs/38_j2020a.R")
```

### Num 49 [@karvonen2019a]

-   Exposure: richness / diversity / taxa

-   Outcome: asthma / respiratory symptoms / wheezing phenotypes

-   Control variables: living on a farm, maternal history of allergic diseases, sex, number of older siblings, and smoking during pregnancy. Study cohort and time were additional adjustment variables which I will not include in DAG since I believe these are typical variables of control due to the study design. 

-   Other: increased animal contacts, natural as opposed to mechanical ventilation and timber structures were associated with increase in asthma protection associated microbes and with decrease in the asthma predisposing Lactococcus abundance. 

```{r}
#| echo: true
source("implied_graphs/49_karvonen2019a.R")
```

```{r}
#| eval: false 

# Work not yet completed to ignore when rendering

\pagebreak
### Num 53 [@o2018a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 65 [@tischer2016a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 73 [@dannemiller2016b]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 94 [@lee-a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 118 [@valkonen2018a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 127 [@dannemiller2014a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 130 [@johansson2013a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 132 [@ege2012a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 134 [@ege2011a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


\pagebreak
### Num 137 [@maier2010a]

-   Exposure: 

-   Outcome: 

-   Control variables: 

-   Other: 


```

\pagebreak
# Join edges tables and assess characteristics 

```{r}
source("scripts/edges_implied_graphs.R")
```

So far, I have assessed **`r length( unique(combined_edges$Num) )`** out of the **`r count(subset_studies)` studies** studies included for the DAG mapping. 

This procedure produced a total of **`r count(combined_edges)`** edges. 

The number of edges after de-duplication is: 
```{r}
combined_edges %>% 
  select(v,w) %>% 
  unique() %>% 
  count() %>% 
  gt
```


```{r}
nodes <- unique(
  c(combined_edges$v, combined_edges$w)
  )
```
The number of variables (nodes) present is **`r length(nodes)`**.    

If I were to only assess relationships between every variable with the exposure and outcome, ignoring all relationships between covariates, I would need to assess **`r (length(nodes)-2)*2` edges**.  

How many edges would I need to assess to produce a saturated DAG? 
```{r}
random_DAG <- randomDAG(
  N = length(nodes),
  p = 0.5
)

plot(random_DAG)
```

This hypothetical DAG with the same number of variables contains **`r count(edges(random_DAG))`** edges that I would need to assess individually. 


\pagebreak

# Package references

```{r}
#| include: false
report::cite_packages(session)
```

  - Grolemund G, Wickham H (2011). “Dates and Times Made Easy with lubridate.” _Journal of Statistical Software_, *40*(3), 1-25. <https://www.jstatsoft.org/v40/i03/>.
  - Iannone R, Cheng J, Schloerke B, Hughes E, Lauer A, Seo J (2024). _gt: Easily Create Presentation-Ready Display Tables_. R package version 0.10.1, <https://CRAN.R-project.org/package=gt>.
  - Makowski D, Lüdecke D, Patil I, Thériault R, Ben-Shachar M, Wiernik B (2023). “Automated Results Reporting as a Practical Tool to Improve Reproducibility and Methodological Best Practices Adoption.” _CRAN_. <https://easystats.github.io/report/>.
  - Müller K, Wickham H (2023). _tibble: Simple Data Frames_. R package version 3.2.1, <https://CRAN.R-project.org/package=tibble>.
  - R Core Team (2024). _R: A Language and Environment for Statistical Computing_. R Foundation for Statistical Computing, Vienna, Austria. <https://www.R-project.org/>.
  - Rinker TW, Kurkiewicz D (2018). _pacman: Package Management for R_. version 0.5.0, <http://github.com/trinker/pacman>.
  - Textor J, van der Zander B, Gilthorpe MS, Liśkiewicz M, Ellison GT (2016). “Robust causal inference using directed acyclic graphs: the R package 'dagitty'.” _International Journal of Epidemiology_, *45*(6), 1887-1894. doi:10.1093/ije/dyw341 <https://doi.org/10.1093/ije/dyw341>.
  - Wickham H (2016). _ggplot2: Elegant Graphics for Data Analysis_. Springer-Verlag New York. ISBN 978-3-319-24277-4, <https://ggplot2.tidyverse.org>.
  - Wickham H (2023). _forcats: Tools for Working with Categorical Variables (Factors)_. R package version 1.0.0, <https://CRAN.R-project.org/package=forcats>.
  - Wickham H (2023). _stringr: Simple, Consistent Wrappers for Common String Operations_. R package version 1.5.1, <https://CRAN.R-project.org/package=stringr>.
  - Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). “Welcome to the tidyverse.” _Journal of Open Source Software_, *4*(43), 1686. doi:10.21105/joss.01686 <https://doi.org/10.21105/joss.01686>.
  - Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. R package version 1.1.4, <https://CRAN.R-project.org/package=dplyr>.
  - Wickham H, Henry L (2023). _purrr: Functional Programming Tools_. R package version 1.0.2, <https://CRAN.R-project.org/package=purrr>.
  - Wickham H, Hester J, Bryan J (2024). _readr: Read Rectangular Text Data_. R package version 2.1.5, <https://CRAN.R-project.org/package=readr>.
  - Wickham H, Vaughan D, Girlich M (2024). _tidyr: Tidy Messy Data_. R package version 1.3.1, <https://CRAN.R-project.org/package=tidyr>.

# References studies 

```{r}
#| include: false  
# Run this chunk if you wish to clear your environment and unload packages.

rm(list = ls())
pacman::p_unload(negate = TRUE)

```
